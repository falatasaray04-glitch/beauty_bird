<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Beauty Bird</title>
  <style>
    :root{
      --bg:#0b1220;
      --text:#e8eefc;
      --muted:#9fb3d8;
      --accent: #38bdf8;
      --primary: #8b5cf6;
      --danger: #ef4444;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      min-height:100vh;
      display:grid;
      place-items:center;
      background: var(--bg);
      color:var(--text);
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      overflow: hidden;
    }

    .wrap{
      width:min(460px, 96vw);
      height: min(740px, 92vh);
      position: relative;
    }

    .gamecard{
      position:relative;
      width: 100%;
      height: 100%;
      background: #000;
      border:1px solid rgba(125,211,252,.18);
      border-radius:28px;
      overflow:hidden;
      box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);
    }

    canvas{display:block; width:100%; height:100%; object-fit: cover;}

    /* A√áILI≈û EKRANI (SPLASH SCREEN) */
    #splashScreen {
      position: absolute;
      inset: 0;
      z-index: 1000;
      background: var(--bg);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      transition: opacity 0.8s cubic-bezier(0.4, 0, 0.2, 1), visibility 0.8s;
      cursor: pointer;
    }

    .splash-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 30px;
      position: relative;
      width: 100%;
      height: 100%;
      justify-content: center;
    }

    /* Karakter √áemberi */
    .splash-bird-box {
      width: 60px;
      height: 60px;
      position: absolute;
      border-radius: 50%;
      border: 3px solid var(--accent);
      overflow: hidden;
      background: #fde68a;
      top: -100px;
      left: -100px;
      display: none; /* Ba≈ülangƒ±√ßta gizli, dokununca g√∂r√ºn√ºr */
      align-items: center;
      justify-content: center;
      z-index: 1001;
    }

    /* U√ßu≈ü Animasyonu: Sol √ºstten merkeze */
    .bird-fly-in {
      display: flex;
      animation: birdIntro 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
    }

    /* √áarpƒ±≈üma sonrasƒ± d√º≈ü√º≈ü */
    .bird-crash-fall {
      animation: birdFall 1s cubic-bezier(0.55, 0.055, 0.675, 0.19) forwards;
    }

    @keyframes birdIntro {
      0% { top: -100px; left: -100px; transform: rotate(30deg); }
      100% { top: 310px; left: 180px; transform: rotate(10deg); }
    }

    @keyframes birdFall {
      0% { top: 310px; left: 180px; transform: rotate(10deg); }
      20% { top: 280px; left: 210px; transform: rotate(-20deg); }
      100% { top: 850px; left: 250px; transform: rotate(360deg); }
    }

    .loading-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 15px;
      margin-top: 120px;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .loading-bar-container {
      width: 200px;
      height: 8px;
      background: rgba(255,255,255,0.05);
      border-radius: 10px;
      overflow: hidden;
      border: 1px solid rgba(255,255,255,0.1);
    }

    .loading-bar-fill {
      width: 0%;
      height: 100%;
      background: linear-gradient(90deg, var(--accent), var(--primary));
      box-shadow: 0 0 15px var(--accent);
      transition: width 0.1s ease;
    }

    .loading-text {
      font-size: 18px;
      font-weight: 900;
      letter-spacing: 4px;
      color: #fff;
      text-transform: uppercase;
      -webkit-text-stroke: 1.5px #000;
      paint-order: stroke fill;
    }

    /* Giri≈ü uyarƒ±sƒ± */
    #startPrompt {
      position: absolute;
      font-size: 14px;
      font-weight: 800;
      letter-spacing: 2px;
      color: var(--accent);
      text-transform: uppercase;
      animation: pulseText 1.5s ease-in-out infinite;
    }

    @keyframes pulseText {
      0%, 100% { opacity: 0.4; transform: scale(1); }
      50% { opacity: 1; transform: scale(1.05); }
    }

    .shake {
      animation: textShake 0.4s cubic-bezier(.36,.07,.19,.97) both;
    }

    @keyframes textShake {
      10%, 90% { transform: translate3d(-1px, 0, 0); }
      20%, 80% { transform: translate3d(2px, 0, 0); }
      30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
      40%, 60% { transform: translate3d(4px, 0, 0); }
    }

    /* Men√º Overlay */
    .menu-overlay {
      position: absolute;
      inset: 0;
      z-index: 50;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      transition: opacity 0.4s ease;
    }

    /* Blurlu Arka Plan Katmanƒ± */
    .menu-bg {
      position: absolute;
      inset: -20px;
      z-index: -1;
      background-size: cover;
      background-position: center;
      filter: blur(25px) brightness(0.5);
      transition: all 0.5s ease;
    }

    /* √úst Bar */
    .top-bar {
      position: absolute;
      top: 25px;
      left: 0;
      right: 0;
      padding: 0 20px;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      z-index: 60;
    }

    .stats-center {
      text-align: center;
      pointer-events: none;
    }
    .stats-label { font-size: 10px; color: var(--muted); text-transform: uppercase; letter-spacing: 2px; font-weight: 700; margin-bottom: 2px; }
    .stats-value { font-size: 20px; font-weight: 900; color: #fff; line-height: 1; text-shadow: 0 2px 10px rgba(0,0,0,0.5); }

    .icon-btn {
      width: 44px;
      height: 44px;
      border-radius: 14px;
      background: rgba(255,255,255,0.1);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.1);
      cursor: pointer;
      display: grid;
      place-items: center;
      transition: all 0.2s;
      color: #fff;
    }
    .icon-btn:hover { background: rgba(255,255,255,0.2); transform: scale(1.05); }
    .icon-btn.danger { color: var(--danger); }

    /* Se√ßici Alanlarƒ± */
    .selectors-container {
      width: 96%;
      display: flex;
      flex-direction: row;
      justify-content: center;
      gap: 10px;
      margin-bottom: 30px;
    }

    .selector-box { flex: 1; min-width: 0; display: flex; flex-direction: column; align-items: center; gap: 15px; padding: 15px 8px; }

    .selector-label { 
      font-size: 18px; color: var(--accent); font-weight: 900; text-transform: uppercase; letter-spacing: 2px;
      -webkit-text-stroke: 1.2px #000; paint-order: stroke fill; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5));
    }
    
    .selector-controls { display: flex; align-items: center; justify-content: space-between; width: 100%; }

    .preview-visual {
      width: 56px; height: 56px; background: rgba(255,255,255,0.1); border-radius: 50%;
      display: flex; align-items: center; justify-content: center; overflow: hidden; border: 2px solid rgba(255,255,255,0.2); box-shadow: 0 8px 20px rgba(0,0,0,0.3);
    }
    .preview-visual img, .preview-visual .theme-dot { width: 38px; height: 38px; object-fit: contain; }
    .theme-dot { border-radius: 10px; }

    .arrow {
      background: rgba(255,255,255,0.12); border: none; color: #fff; width: 34px; height: 34px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 16px; transition: all 0.2s;
    }
    .arrow:hover { background: var(--accent); color: #000; transform: scale(1.1); }
    
    .selection-text { font-size: 15px; font-weight: 800; color: #fff; margin-top: 2px; white-space: nowrap; letter-spacing: 0.5px; text-transform: capitalize; }

    .start-btn {
      padding: 18px 65px; border-radius: 22px; background: linear-gradient(135deg, var(--accent), var(--primary));
      color: #fff; font-size: 20px; font-weight: 900; border: none; cursor: pointer; box-shadow: 0 12px 30px rgba(56, 189, 248, 0.3); transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); text-transform: uppercase; letter-spacing: 2px;
    }
    .start-btn:hover { transform: translateY(-4px); box-shadow: 0 15px 40px rgba(56, 189, 248, 0.5); }
    .start-btn:active { transform: scale(0.96); }

    .settings-panel {
      position: absolute; inset: 20px; background: rgba(10, 15, 30, 0.98); backdrop-filter: blur(25px); border-radius: 24px; z-index: 100; padding: 35px 25px; display: none; flex-direction: column; gap: 20px; border: 1px solid rgba(255,255,255,0.1);
    }
    .settings-panel .title { margin: 0; text-align: center; color: #fff; font-weight: 900; letter-spacing: 1px; }

    /* Ayar s√ºrg√ºleri i√ßin tam geni≈ülik d√ºzenlemesi */
    .settings-panel input[type="range"] {
      width: 100%;
      cursor: pointer;
      display: block;
      margin-top: 5px;
    }

    .hidden { opacity: 0; pointer-events: none; visibility: hidden; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="gamecard">
      <canvas id="c" width="420" height="740"></canvas>

      <!-- A√áILI≈û EKRANI -->
      <div id="splashScreen">
        <div class="splash-content">
          <div id="startPrompt">BA≈ûLATMAK ƒ∞√áƒ∞N DOKUN</div>
          <div id="splashBirdBox" class="splash-bird-box">
             <img id="splashBirdImg" src="bird.png" style="width:100%; height:100%; object-fit:cover;">
          </div>
          <div id="loadingUI" class="loading-container">
            <div id="loadingText" class="loading-text">Y√ºkleniyor</div>
            <div class="loading-bar-container">
              <div class="loading-bar-fill" id="loadingFill"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- ANA MEN√ú -->
      <div class="menu-overlay hidden" id="menuOverlay">
        <div class="menu-bg" id="menuBg"></div>
        
        <div class="top-bar">
          <button class="icon-btn danger" id="resetBtn" title="Skoru Sƒ±fƒ±rla">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path><path d="M3 3v5h5"></path></svg>
          </button>
          
          <div class="stats-center">
            <div class="stats-label">Skor / Rekor</div>
            <div class="stats-value">
              <span id="lastScoreVal">0</span> <span style="font-weight:400; color:var(--muted); font-size:14px;">/</span> <span style="color:var(--accent)" id="bestScoreVal">0</span>
            </div>
          </div>
          
          <button class="icon-btn" id="settingsBtn">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path><circle cx="12" cy="12" r="3"></circle></svg>
          </button>
        </div>

        <div class="selectors-container">
          <!-- Karakter Se√ßici -->
          <div class="selector-box">
            <div class="selector-label">Karakterler</div>
            <div class="selector-controls">
              <button class="arrow" id="charLeft">‚ùÆ</button>
              <div class="preview-visual">
                <img id="charPreviewImg" src="bird.png" alt="Ku≈ü √ñnizleme">
              </div>
              <button class="arrow" id="charRight">‚ùØ</button>
            </div>
            <div class="selection-text" id="charText">Ku≈ü 1</div>
          </div>
          
          <!-- Tema Se√ßici -->
          <div class="selector-box">
            <div class="selector-label">Temalar</div>
            <div class="selector-controls">
              <button class="arrow" id="themeLeft">‚ùÆ</button>
              <div class="preview-visual">
                <div id="themePreviewBox" class="theme-dot"></div>
              </div>
              <button class="arrow" id="themeRight">‚ùØ</button>
            </div>
            <div class="selection-text" id="themeText">Klasik</div>
          </div>
        </div>

        <button class="start-btn" id="playBtn">BA≈ûLAT</button>
      </div>

      <!-- Ayarlar Paneli -->
      <div class="settings-panel" id="settingsPanel">
        <h3 class="title">OYUN AYARLARI</h3>
        <div style="display:grid; gap:30px; margin-top:30px;">
          <label style="display: block;">
            <div class="stats-label" id="sfxLabel" style="margin-bottom:10px; font-size: 12px; color: #fff;">Efekt Sesleri (%55)</div>
            <input id="sfxRange" type="range" min="0" max="1" step="0.01">
          </label>
          <label style="display: block;">
            <div class="stats-label" id="bgmLabel" style="margin-bottom:10px; font-size: 12px; color: #fff;">M√ºzik Sesi (%22)</div>
            <input id="bgmRange" type="range" min="0" max="1" step="0.01">
          </label>
          <button class="start-btn" id="closeSettingsBtn" style="margin-top:20px; width: 100%;">TAMAM</button>
        </div>
      </div>
    </div>
  </div>

  <script>
  'use strict';

  window.addEventListener('DOMContentLoaded', () => {
    const canvas = document.getElementById('c');
    const ctx = canvas.getContext('2d');

    const splashScreen = document.getElementById('splashScreen');
    const splashBirdBox = document.getElementById('splashBirdBox');
    const splashBirdImg = document.getElementById('splashBirdImg');
    const startPrompt = document.getElementById('startPrompt');
    const loadingUI = document.getElementById('loadingUI');
    const loadingFill = document.getElementById('loadingFill');
    const loadingText = document.getElementById('loadingText');
    const menuOverlay = document.getElementById('menuOverlay');
    const menuBg = document.getElementById('menuBg');
    const playBtn = document.getElementById('playBtn');
    const settingsBtn = document.getElementById('settingsBtn');
    const settingsPanel = document.getElementById('settingsPanel');
    const closeSettingsBtn = document.getElementById('closeSettingsBtn');
    const resetBtn = document.getElementById('resetBtn');

    const charText = document.getElementById('charText');
    const charPreviewImg = document.getElementById('charPreviewImg');
    const themeText = document.getElementById('themeText');
    const themePreviewBox = document.getElementById('themePreviewBox');
    
    const lastScoreVal = document.getElementById('lastScoreVal');
    const bestScoreVal = document.getElementById('bestScoreVal');

    // ======== Varlƒ±klar (Assets) ========
    const bird1Img = new Image(); bird1Img.src = 'bird.png';
    const bird2Img = new Image(); bird2Img.src = 'bird2.png';

    // ======== Temalar ve Karakterler ========
    const themes = [
      { name: 'Klasik', bgm: 'bgm.mp3', bg: '#bfe9ff', isImage: false, circle: '#f472b6' },
      { name: 'Tema 1', bgm: 'bgm1.mp3', bg: 'bg1.png', isImage: true, circle: '#800080' },
      { name: 'Tema 2', bgm: 'bgm2.mp3', bg: 'bg2.png', isImage: true, circle: '#0000ff' }
    ];

    const themeBgs = [null, new Image(), new Image()];
    themeBgs[1].src = 'bg1.png';
    themeBgs[2].src = 'bg2.png';

    const characters = [
      { name: 'Ku≈ü 1', img: bird1Img, src: 'bird.png' },
      { name: 'Ku≈ü 2', img: bird2Img, src: 'bird2.png' }
    ];

    let currentTheme = parseInt(localStorage.getItem('flappy_theme') || '0');
    let currentChar = parseInt(localStorage.getItem('flappy_char') || '0');

    // ======== Ses Y√∂netimi ========
    const clamp01 = (v) => Math.max(0, Math.min(1, Number(v)));

    function makePool(src, size, volume){
      const pool = Array.from({length:size}, () => {
        const a = new Audio(src);
        a.preload = 'auto';
        a.volume = volume;
        return a;
      });
      let idx = 0;
      let vol = volume;
      return {
        prime(){
          for(const a of pool){
            try { a.play().then(() => { a.pause(); a.currentTime = 0; }).catch(()=>{}); } catch(_) {}
          }
        },
        play(){
          const a = pool[idx];
          idx = (idx + 1) % pool.length;
          try {
            a.currentTime = 0;
            a.volume = vol;
            const p = a.play();
            if(p && typeof p.then === 'function') p.catch(()=>{});
          } catch(_) {}
        },
        setVolume(v){
          vol = clamp01(v);
          for(const a of pool){ a.volume = vol; }
        },
        getVolume(){ return vol; }
      };
    }

    const savedSfx = clamp01(localStorage.getItem('vol_sfx') || 0.55);
    const savedBgm = clamp01(localStorage.getItem('vol_bgm') || 0.22);

    const sfxJump  = makePool('jump.mp3', 6, savedSfx);
    const sfxPoint = makePool('point.mp3', 4, savedSfx);
    const sfxCrash = makePool('gameover.mp3', 3, clamp01(savedSfx + 0.15));
    const sfxWater = makePool('water.mp3', 3, savedSfx);

    let bgm = new Audio(themes[currentTheme].bgm);
    bgm.loop = true;
    bgm.volume = savedBgm;

    // ======== Oyun Sabitleri ========
    const W = canvas.width;
    const H = canvas.height;
    const GRAVITY = 0.75;
    const JUMP_VY = -14.5;
    const MAX_FALL = 18.0;
    const PIPE_W = 86;
    const PIPE_GAP_BASE = 200;  
    const PIPE_SPACING = 480;   
    const GROUND_H = 74;
    const BIRD_R = 18;
    const BIRD_X = Math.round(W * 0.28);

    // ======== Oyun Durumu (State) ========
    let running = true;
    let started = false;
    let waitingForFirstTouch = false;
    let gameOver = false;
    let collided = false;
    let sinking = false;
    let sinkAmount = 0;
    let score = 0;
    let lastSessionScore = 0; // Men√ºde g√∂sterilecek son skor
    let best = Number(localStorage.getItem('flappy_best') || 0);
    let lastTime = 0;
    let t = 0;
    let pipes = [];
    let particles = [];
    let splash = [];
    let shakeT = 0;
    let shakeMag = 0;

    const bird = { x: BIRD_X, y: Math.round(H * 0.45), vy: 0, rot: 0, scale: 1, scaleVel: 0 };

    // ======== A√ßƒ±lƒ±≈ü Ekranƒ± Mantƒ±ƒüƒ± ========
    function runSplashSequence() {
      // √ñnce havuzlarƒ± hazƒ±rla (Unlock audio)
      sfxJump.prime();
      sfxCrash.prime();
      
      startPrompt.style.display = 'none';
      loadingUI.style.opacity = '1';
      splashBirdBox.style.display = 'flex';
      
      // Karakter resmini ve temayƒ± splash ekranƒ±na uygula
      splashBirdImg.src = characters[currentChar].src;
      splashBirdBox.style.borderColor = themes[currentTheme].circle;

      // 1. Ku≈ü ekranƒ±n sol √ºst√ºnden gelmeye ba≈ülar
      setTimeout(() => {
        splashBirdBox.classList.add('bird-fly-in');
        
        // 2. Ku≈ü yazƒ±ya √ßarpar (0.8s animasyon bittiƒüinde)
        setTimeout(() => {
          // Ses √ßal - Artƒ±k kullanƒ±cƒ± dokunduƒüu i√ßin √ßalƒ±≈üacak
          sfxCrash.play();
          
          // Yazƒ±yƒ± titret
          loadingText.classList.add('shake');
          
          // Ku≈ü √ßarpƒ±≈üma ve d√º≈ü√º≈ü animasyonuna ge√ßer
          splashBirdBox.classList.remove('bird-fly-in');
          splashBirdBox.classList.add('bird-crash-fall');

          // 3. Y√ºkleme barƒ± dolmaya ba≈ülar
          let progress = 0;
          const interval = setInterval(() => {
            progress += Math.random() * 12;
            if (progress >= 100) {
              progress = 100;
              clearInterval(interval);
              // Men√ºye ge√ßi≈ü
              setTimeout(() => {
                splashScreen.style.opacity = '0';
                setTimeout(() => {
                  splashScreen.style.display = 'none';
                  menuOverlay.classList.remove('hidden');
                  updateMenuUI();
                }, 800);
              }, 500);
            }
            loadingFill.style.width = `${progress}%`;
          }, 100);

        }, 800);
      }, 300);
    }

    // ƒ∞lk etkile≈üimi bekle
    splashScreen.addEventListener('pointerdown', function startHandler() {
      splashScreen.removeEventListener('pointerdown', startHandler);
      runSplashSequence();
    });

    // ======== Men√º Fonksiyonlarƒ± ========
    function updateMenuUI() {
      charText.textContent = characters[currentChar].name;
      charPreviewImg.src = characters[currentChar].src;
      
      themeText.textContent = themes[currentTheme].name;
      bestScoreVal.textContent = best;
      lastScoreVal.textContent = lastSessionScore; // D√úZELTME: Session skorunu g√∂ster

      const theme = themes[currentTheme];
      if (theme.isImage) {
        menuBg.style.backgroundImage = `url('${theme.bg}')`;
        menuBg.style.backgroundColor = 'transparent';
        themePreviewBox.style.backgroundImage = `url('${theme.bg}')`;
        themePreviewBox.style.backgroundSize = 'cover';
        themePreviewBox.style.backgroundColor = 'transparent';
      } else {
        menuBg.style.backgroundImage = 'none';
        menuBg.style.backgroundColor = theme.bg;
        themePreviewBox.style.backgroundImage = 'none';
        themePreviewBox.style.backgroundColor = theme.bg;
      }
    }

    function switchTheme(delta) {
      currentTheme = (currentTheme + delta + themes.length) % themes.length;
      localStorage.setItem('flappy_theme', currentTheme);
      updateMenuUI();
      bgm.pause();
      bgm = new Audio(themes[currentTheme].bgm);
      bgm.loop = true;
      bgm.volume = savedBgm;
    }

    function switchCharacter(delta) {
      currentChar = (currentChar + delta + characters.length) % characters.length;
      localStorage.setItem('flappy_char', currentChar);
      updateMenuUI();
    }

    // ======== Oyun Mantƒ±ƒüƒ± ========
    function spawnSplash(x, y){
      if(currentTheme !== 0) return;
      for(let i=0; i<20; i++){
        const ang = (-Math.PI * 0.98) + Math.random() * (Math.PI * 0.96);
        const spd = 3 + Math.random() * 4;
        splash.push({ x, y, vx: Math.cos(ang) * spd, vy: Math.sin(ang) * spd, life: 40 + Math.random()*20 });
      }
    }

    function spawnParticle() {
      if (currentTheme === 0) return;
      const isLeft = Math.random() > 0.5;
      particles.push({
        x: isLeft ? rand(10, 60) : rand(W - 60, W - 10),
        y: H + 20,
        vy: -rand(1, 3),
        vx: (Math.random() - 0.5) * 0.5,
        size: rand(16, 24),
        content: currentTheme === 1 ? '‚ù§Ô∏è' : 'üòç',
        opacity: 1,
        rot: (Math.random() - 0.5) * 0.2
      });
    }

    function spawnPipe(x){
      const gap = PIPE_GAP_BASE - Math.min(score * 0.9, 70);
      const limitH = (currentTheme === 0) ? H - GROUND_H : H;
      const topMin = 60;
      const topMax = limitH - 60 - gap;
      const topH = rand(topMin, topMax);
      
      let colors = ['#ef4444', '#3b82f6', '#f59e0b', '#8b5cf6', '#ec4899', '#06b6d4', '#f97316', '#22c55e'];
      if(currentTheme === 1) colors = colors.filter(c => c !== '#8b5cf6' && c !== '#ec4899');
      else if(currentTheme === 2) colors = colors.filter(c => c !== '#3b82f6' && c !== '#06b6d4');
      
      pipes.push({ x, topH, gap, passed:false, color: colors[Math.floor(Math.random() * colors.length)] });
    }

    function resetRound(){
      started = false; 
      waitingForFirstTouch = false;
      gameOver = false; 
      collided = false; 
      sinking = false;
      sinkAmount = 0; 
      pipes = []; 
      particles = []; 
      splash = [];
      bird.y = Math.round(H * 0.45); 
      bird.vy = 0; 
      bird.rot = 0;
      score = 0; // Burada skoru sƒ±fƒ±rlƒ±yoruz ama lastSessionScore'da eski deƒüer duruyor
      t = 0;
      spawnInitialPipes();
      menuOverlay.classList.remove('hidden');
      updateMenuUI();
    }

    function spawnInitialPipes(){
      const startX = W + 200;
      pipes = [];
      for(let i=0;i<4;i++) spawnPipe(startX + i*PIPE_SPACING);
    }

    function startGame(){
      waitingForFirstTouch = true;
      started = true;
      menuOverlay.classList.add('hidden');
      sfxJump.prime();
    }

    // ======== Giri≈ü Dinleyicileri ========
    playBtn.onclick = (e) => { e.stopPropagation(); startGame(); };
    settingsBtn.onclick = (e) => { e.stopPropagation(); settingsPanel.style.display = 'flex'; };
    closeSettingsBtn.onclick = (e) => { e.stopPropagation(); settingsPanel.style.display = 'none'; };
    resetBtn.onclick = (e) => { e.stopPropagation(); best = 0; score = 0; lastSessionScore = 0; localStorage.setItem('flappy_best', '0'); updateMenuUI(); };

    document.getElementById('charLeft').onclick = (e) => { e.stopPropagation(); switchCharacter(-1); };
    document.getElementById('charRight').onclick = (e) => { e.stopPropagation(); switchCharacter(1); };
    document.getElementById('themeLeft').onclick = (e) => { e.stopPropagation(); switchTheme(-1); };
    document.getElementById('themeRight').onclick = (e) => { e.stopPropagation(); switchTheme(1); };

    const sfxRange = document.getElementById('sfxRange');
    const bgmRange = document.getElementById('bgmRange');
    sfxRange.value = savedSfx;
    bgmRange.value = savedBgm;

    sfxRange.oninput = (e) => {
      const v = clamp01(e.target.value);
      sfxJump.setVolume(v); sfxPoint.setVolume(v); sfxCrash.setVolume(clamp01(v + 0.15)); sfxWater.setVolume(v);
      localStorage.setItem('vol_sfx', v);
      document.getElementById('sfxLabel').textContent = `Efekt Sesleri (%${Math.round(v*100)})`;
      sfxPoint.play();
    };
    bgmRange.oninput = (e) => {
      const v = clamp01(e.target.value);
      bgm.volume = v;
      localStorage.setItem('vol_bgm', v);
      document.getElementById('bgmLabel').textContent = `M√ºzik Sesi (%${Math.round(v*100)})`;
    };

    window.addEventListener('keydown', (e) => {
      if(e.code === 'Space' || e.code === 'ArrowUp') {
        e.preventDefault();
        handleInteraction();
      }
    });

    canvas.onpointerdown = (e) => {
      handleInteraction();
    };

    function handleInteraction() {
      if(!started) return;
      if(waitingForFirstTouch) {
        waitingForFirstTouch = false;
        bgm.play().catch(()=>{});
        jump();
      } else if(!gameOver && !collided) {
        jump();
      }
    }

    function jump(){
      bird.vy = JUMP_VY;
      sfxJump.play();
      bird.scale = 1.08; bird.scaleVel = -0.015;
    }

    // ======== D√∂ng√º & Render ========
    function loop(timestamp){
      if (!lastTime) lastTime = timestamp;
      const ts = Math.min((timestamp - lastTime) / (1000 / 60), 5); 
      lastTime = timestamp;
      update(ts);
      draw();
      requestAnimationFrame(loop);
    }

    function update(ts){
      t += ts;
      if(Math.random() < 0.05 * ts) spawnParticle();
      if(started && !waitingForFirstTouch && !collided){
        bird.vy += GRAVITY * ts;
        bird.vy = Math.min(bird.vy, MAX_FALL);
        bird.y += bird.vy * ts;
        bird.rot = clamp(bird.vy / 18, -0.6, 0.6);
        const spd = (4.2 + score * 0.001) * ts;
        for(const p of pipes){
          p.x -= spd;
          if(!p.passed && p.x + PIPE_W < bird.x){ p.passed = true; score++; sfxPoint.play(); }
        }
        if(pipes.length > 0 && pipes[0].x + PIPE_W < -100){ pipes.shift(); spawnPipe(pipes[pipes.length-1].x + PIPE_SPACING); }
        if(bird.y < 0) triggerCrash();
        if(checkPipeCollision()) triggerCrash();
        const deathLimit = (currentTheme === 0) ? H - GROUND_H : H;
        if(bird.y + BIRD_R >= deathLimit){ if(currentTheme === 0) sfxWater.play(); triggerCrash(); }
      } else if (started && collided && !gameOver) {
        bird.vy += GRAVITY * 0.8 * ts;
        bird.y += bird.vy * ts;
        bird.rot += 0.05 * ts;
        if(currentTheme === 0){
          if(!sinking && bird.y + BIRD_R >= H - GROUND_H){ sinking = true; spawnSplash(bird.x, H-GROUND_H+5); }
          if(sinking){ sinkAmount += 2.2 * ts; bird.y += 2.2 * ts; if(sinkAmount > 50) end(); }
        } else { if(bird.y > H + 50) end(); }
      }
      particles.forEach(p => { p.y += p.vy * ts; p.opacity -= 0.005 * ts; });
      particles = particles.filter(p => p.opacity > 0);
      splash.forEach(p => { p.x += p.vx * ts; p.y += p.vy * ts; p.vy += 0.3 * ts; p.life -= ts; });
      splash = splash.filter(p => p.life > 0);
    }

    function triggerCrash(){
      if(collided) return;
      collided = true;
      sfxCrash.play();
      shakeT = 10; shakeMag = 5;
    }

    function end(){
      gameOver = true;
      lastSessionScore = score; // D√úZELTME: Oyun biterken skoru session deƒüi≈ükenine aktar
      if(score > best) { best = score; localStorage.setItem('flappy_best', best); }
      bgm.pause(); bgm.currentTime = 0;
      setTimeout(resetRound, 300);
    }

    function checkPipeCollision(){
      const limitH = (currentTheme === 0) ? H - GROUND_H : H;
      for(const p of pipes){
        const px = p.x;
        const py1 = 0; const ph1 = p.topH;
        const py2 = p.topH + p.gap; const ph2 = limitH - py2;
        if(circleRect(bird.x, bird.y, BIRD_R, px, py1, PIPE_W, ph1)) return true;
        if(circleRect(bird.x, bird.y, BIRD_R, px, py2, PIPE_W, ph2)) return true;
      }
      return false;
    }

    function circleRect(cx, cy, r, rx, ry, rw, rh) {
      let testX = cx; let testY = cy;
      if (cx < rx) testX = rx; else if (cx > rx+rw) testX = rx+rw;
      if (cy < ry) testY = ry; else if (cy > ry+rh) testY = ry+rh;
      let d = Math.sqrt((cx-testX)**2 + (cy-testY)**2);
      return d <= r;
    }

    function draw(){
      ctx.save();
      if(shakeT > 0){ ctx.translate((Math.random()*2-1)*shakeMag, (Math.random()*2-1)*shakeMag); shakeT--; }

      // Arka Plan
      if(currentTheme === 0){
        const sky = ctx.createLinearGradient(0,0,0,H);
        sky.addColorStop(0, '#bfe9ff'); sky.addColorStop(1, '#fefefe');
        ctx.fillStyle = sky; ctx.fillRect(0,0,W,H);
        ctx.fillStyle = 'rgba(255, 223, 128, 0.95)'; ctx.beginPath(); ctx.arc(W-80, 80, 40, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = 'rgba(255,255,255,0.95)';
        for(let i=0;i<4;i++){
          const x = (i*160 + t*0.3) % (W+160) - 80;
          const y = 120 + i*60;
          ctx.beginPath(); ctx.ellipse(x, y, 40, 18, 0, 0, Math.PI*2); ctx.ellipse(x+30, y-10, 30, 14, 0, 0, Math.PI*2); ctx.ellipse(x+60, y, 36, 16, 0, 0, Math.PI*2); ctx.fill();
        }
      } else {
        const bgImg = themeBgs[currentTheme];
        if (bgImg && bgImg.complete && bgImg.naturalWidth > 0) ctx.drawImage(bgImg, 0, 0, W, H);
        else { ctx.fillStyle = currentTheme === 1 ? '#fee2e2' : '#fef3c7'; ctx.fillRect(0,0,W,H); }
      }

      particles.forEach(p => {
        ctx.save(); ctx.globalAlpha = p.opacity; ctx.font = `${p.size}px serif`;
        ctx.translate(p.x, p.y); ctx.rotate(p.rot); ctx.fillText(p.content, -p.size/2, p.size/2); ctx.restore();
      });

      drawPipes();
      if(sinking){ drawBird(); drawGround(); } else { drawGround(); drawBird(); }

      splash.forEach(p => { ctx.fillStyle = 'rgba(235, 250, 255, 0.95)'; ctx.beginPath(); ctx.arc(p.x, p.y, 3, 0, Math.PI*2); ctx.fill(); });

      // "DOKUN" Yazƒ±sƒ±
      if(started && waitingForFirstTouch) {
        ctx.save();
        const opacity = 0.5 + Math.sin(t * 0.1) * 0.5;
        ctx.globalAlpha = opacity;
        ctx.fillStyle = '#fff';
        ctx.font = '900 60px Inter';
        ctx.textAlign = 'center';
        ctx.letterSpacing = '4px';
        ctx.lineWidth = 4;
        ctx.strokeStyle = '#000';
        ctx.strokeText('DOKUN', W/2, H/2);
        ctx.fillText('DOKUN', W/2, H/2);
        ctx.restore();
      }

      // Oyun ƒ∞√ßi Skor
      if(started && !gameOver && !waitingForFirstTouch){
        ctx.save();
        ctx.fillStyle = '#fff'; 
        ctx.font = '900 36px Inter'; 
        ctx.textAlign = 'center';
        ctx.shadowColor = 'rgba(0,0,0,0.8)'; 
        ctx.shadowBlur = 10;
        ctx.lineWidth = 1.5;
        ctx.strokeStyle = '#000';
        ctx.strokeText(score, W/2, 80);
        ctx.fillText(score, W/2, 80);
        ctx.restore();
      }
      ctx.restore();
    }

    function drawPipes(){
      const limitH = (currentTheme === 0) ? H - GROUND_H : H;
      pipes.forEach(p => {
        if (currentTheme === 0) {
          const pipeGrad = ctx.createLinearGradient(p.x, 0, p.x + PIPE_W, 0);
          pipeGrad.addColorStop(0, '#22c55e'); pipeGrad.addColorStop(0.5, '#16a34a'); pipeGrad.addColorStop(1, '#22c55e');
          ctx.fillStyle = pipeGrad; ctx.strokeStyle = '#14532d';
        } else { ctx.fillStyle = p.color; ctx.strokeStyle = '#000'; }
        ctx.lineWidth = 3;
        roundRect(ctx, p.x, 0, PIPE_W, p.topH, 10); ctx.fill(); ctx.stroke();
        roundRect(ctx, p.x, p.topH + p.gap, PIPE_W, limitH - (p.topH + p.gap), 10); ctx.fill(); ctx.stroke();
        if (currentTheme === 0) ctx.fillStyle = '#16a34a';
        ctx.fillRect(p.x - 6, p.topH - 18, PIPE_W + 12, 18);
        ctx.strokeRect(p.x - 6, p.topH - 18, PIPE_W + 12, 18);
        ctx.fillRect(p.x - 6, p.topH + p.gap, PIPE_W + 12, 18);
        ctx.strokeRect(p.x - 6, p.topH + p.gap, PIPE_W + 12, 18);
      });
    }

    function drawGround(){
      if(currentTheme !== 0) return;
      const y = H - GROUND_H;
      ctx.fillStyle = 'rgba(15,26,51,.95)'; ctx.fillRect(0, y, W, GROUND_H);
      ctx.save(); ctx.beginPath(); ctx.rect(0, y, W, GROUND_H); ctx.clip();
      const waveCount = 3; const waveAmp = 6; const waveLen = 80;
      for(let j=0; j<waveCount; j++){
        ctx.beginPath(); ctx.strokeStyle = `rgba(125,211,252,${0.35 - j*0.08})`; ctx.lineWidth = 2;
        for(let x=0; x<=W; x+=6){
          const phase = (t*0.06) + j*1.4; const yy = y + 18 + j*14 + Math.sin((x / waveLen) + phase) * waveAmp;
          if(x === 0) ctx.moveTo(x, yy); else ctx.lineTo(x, yy);
        }
        ctx.stroke();
      }
      ctx.restore();
      // √áizgi kaldƒ±rƒ±ldƒ±.
    }

    function drawBird(){
      ctx.save();
      ctx.translate(bird.x, bird.y);
      ctx.rotate(bird.rot);
      const size = BIRD_R * 2.4;
      const img = characters[currentChar].img;
      ctx.beginPath();
      ctx.arc(0, 0, BIRD_R, 0, Math.PI * 2);
      ctx.save(); 
      ctx.clip(); 
      if(img.complete && img.naturalWidth > 0) ctx.drawImage(img, -size/2, -size/2, size, size);
      else { ctx.fillStyle = '#fde68a'; ctx.fill(); }
      ctx.restore(); 
      let strokeColor = themes[currentTheme].circle;
      ctx.strokeStyle = strokeColor; ctx.lineWidth = 3;
      ctx.beginPath(); 
      ctx.arc(0, 0, BIRD_R + 2, 0, Math.PI*2); 
      ctx.stroke();
      ctx.restore();
    }

    function roundRect(ctx, x, y, w, h, r) {
      if (w < 2 * r) r = w / 2; if (h < 2 * r) r = h / 2;
      ctx.beginPath(); ctx.moveTo(x + r, y); ctx.arcTo(x + w, y, x + w, y + h, r);
      ctx.arcTo(x + w, y + h, x, y + h, r); ctx.arcTo(x, y + h, x, y, r);
      ctx.arcTo(x, y, x + w, y, r); ctx.closePath();
    }

    function rand(min, max){ return Math.random() * (max - min) + min; }
    function clamp(v, min, max) { return Math.max(min, Math.min(max, v)); }

    resetRound();
    loop(0);
  });
  </script>
</body>
</html>
